{% extends "base.html" %}

{% block title %}Participações - Sistema de Aluguéis{% endblock %}

{% block head %}
<!-- Handsontable CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css" />
<style>
    .handsontable {
        font-size: 12px;
    }
    .handsontable td {
        text-align: center;
    }
    .handsontable th {
        text-align: center;
        font-weight: 600;
    }
    /* Dark theme for Handsontable */
    .handsontable,
    .handsontable th,
    .handsontable td {
        background-color: var(--card-dark);
        color: white;
        border-color: #374151;
    }
    .handsontable thead th {
        background-color: var(--bg-dark);
        border-bottom: 2px solid #374151;
    }
    .handsontable tbody th {
        background-color: var(--bg-dark);
        font-weight: 600;
    }
    .handsontable .htDimmed {
        color: #9ca3af;
    }
    .handsontable td.area {
        background-color: #1e293b;
    }
    /* Validation errors */
    .validation-error {
        background-color: rgba(239, 68, 68, 0.2) !important;
    }
    .validation-warning {
        background-color: rgba(245, 158, 11, 0.2) !important;
    }
    /* Ensure complete table borders */
    .handsontable table {
        border-collapse: collapse;
    }
    .handsontable table td,
    .handsontable table th {
        border: 1px solid #374151 !important;
    }
    .handsontable table {
        border-bottom: 2px solid #374151 !important;
    }
    .handsontable .wtHolder {
        border: 1px solid #374151;
        border-radius: 8px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-bg-dark">
    <!-- Navbar -->
    {% include "navbar.html" %}

    <!-- Main Content -->
    <div class="max-w-[95%] mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Participações</h1>
                <p class="text-gray-400">Gestão de participações de proprietários nos imóveis</p>
            </div>
            <div class="flex gap-3">
                <select id="version-select" class="bg-[var(--card-dark)] border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[var(--primary)]">
                    <option value="">Versão Atual</option>
                </select>
                <button onclick="validateAndSave()" class="bg-[var(--primary)] hover:bg-blue-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined">save</span>
                    Salvar Versão
                </button>
            </div>
        </div>

        <!-- Validation Status -->
        <div id="validation-status" class="mb-4 hidden">
            <div class="bg-[var(--card-dark)] rounded-lg p-4 border border-gray-800">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined" id="validation-icon"></span>
                    <span id="validation-message" class="text-sm"></span>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-[var(--card-dark)] rounded-lg border border-gray-800 p-6">
            <div id="handsontable-container" class="overflow-x-auto"></div>
        </div>
    </div>
</div>

<!-- Save Modal -->
<div id="save-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-[var(--card-dark)] rounded-lg max-w-md w-full">
        <div class="sticky top-0 bg-[var(--card-dark)] border-b border-gray-800 px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">Salvar Nova Versão</h2>
            <button onclick="closeSaveModal()" class="text-gray-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <form id="save-form" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Nome da Versão *</label>
                <input type="text" id="version-name" required placeholder="Ex: Versão Nov 2025"
                    class="w-full bg-[var(--bg-dark)] border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[var(--primary)]">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Observações</label>
                <textarea id="version-notes" rows="3" placeholder="Observações sobre esta versão..."
                    class="w-full bg-[var(--bg-dark)] border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[var(--primary)]"></textarea>
            </div>

            <div class="flex gap-3 justify-end pt-4 border-t border-gray-800">
                <button type="button" onclick="closeSaveModal()" 
                    class="px-6 py-2 border border-gray-700 text-gray-300 rounded-lg hover:bg-gray-800 transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                    class="px-6 py-2 bg-[var(--primary)] hover:bg-blue-600 text-white rounded-lg transition-colors">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Handsontable JS -->
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>

<script>
let hot = null;
let imoveis = [];
let proprietarios = [];
let currentData = {};
let versions = [];

// Format percentage with Brazilian locale (comma as decimal separator)
function formatPercentage(value) {
    return value.toFixed(2).replace('.', ',') + ' %';
}

// Initialize
async function init() {
    try {
        await loadGridData();
        await loadVersions();
    } catch (error) {
        console.error('Erro na inicialização:', error);
        showToast('Erro ao inicializar a página', 'error');
    }
}

async function loadGridData() {
    try {
        const data = await fetchWithAuth('/api/participacoes-versoes/grid-data');
        if (data && data.imoveis && data.proprietarios) {
            imoveis = data.imoveis;
            proprietarios = data.proprietarios;
            currentData = data.dados || {};
            
            // Only initialize if we have data
            if (imoveis.length > 0 && proprietarios.length > 0) {
                initializeTable();
            } else {
                showToast('Nenhum dado disponível para exibir', 'info');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showToast('Erro ao carregar dados da grid', 'error');
    }
}

async function loadVersions() {
    try {
        versions = await fetchWithAuth('/api/participacoes-versoes/');
        const select = document.getElementById('version-select');
        select.innerHTML = '<option value="">Versão Atual</option>';
        
        versions.forEach(v => {
            const date = new Date(v.created_at).toLocaleDateString('pt-BR');
            select.innerHTML += `<option value="${v.id}">${v.nome} (${date})</option>`;
        });
    } catch (error) {
        console.error('Erro ao carregar versões:', error);
    }
}

function initializeTable() {
    const container = document.getElementById('handsontable-container');
    
    if (!container) {
        console.error('Handsontable container not found');
        return;
    }
    
    // Prepare data for Handsontable
    const tableData = [];
    const colHeaders = ['Nome', 'VALOR'];
    
    // Add proprietario names to headers
    proprietarios.forEach(p => {
        colHeaders.push(p.nome);
    });
    
    // Build rows
    imoveis.forEach(imovel => {
        const row = [imovel.nome];
        
        // Calculate total for this imovel
        let total = 0;
        const imovelData = currentData[imovel.id.toString()] || {};
        
        proprietarios.forEach(prop => {
            const value = imovelData[prop.id.toString()] || 0;
            total += value;
        });
        
        row.push(formatPercentage(total));
        
        // Add each proprietario's participation
        proprietarios.forEach(prop => {
            const value = imovelData[prop.id.toString()] || 0;
            row.push(formatPercentage(value));
        });
        
        tableData.push(row);
    });
    
    // Define columns
    const columns = [
        { data: 0, readOnly: true, className: 'htLeft' }, // Nome
        { data: 1, readOnly: true, className: 'htCenter' }  // VALOR (Total)
    ];
    
    // Add editable columns for proprietarios
    for (let i = 0; i < proprietarios.length; i++) {
        columns.push({
            data: i + 2,
            type: 'text',
            className: 'htCenter'
        });
    }
    
    // Destroy existing instance if any
    if (hot) {
        hot.destroy();
        hot = null;
    }
    
    // Initialize Handsontable
    hot = new Handsontable(container, {
        data: tableData,
        colHeaders: colHeaders,
        columns: columns,
        rowHeaders: false,
        width: '100%',
        height: 600,
        licenseKey: 'non-commercial-and-evaluation',
        stretchH: 'none', // Don't stretch columns, let autoColumnSize handle it
        manualColumnResize: true,
        manualRowResize: false,
        contextMenu: false,
        fillHandle: false, // Disable fill handle to avoid overlay errors
        autoColumnSize: {
            samplingRatio: 23,
            useHeaders: true
        }, // Enable auto column sizing with custom options
        autoRowSize: false,
        disableVisualSelection: false,
        outsideClickDeselects: true,
        enterBeginsEditing: true,
        afterChange: function(changes, source) {
            if (source === 'loadData' || source === 'internal') {
                return;
            }
            if (changes) {
                updateTotals();
                validateData();
            }
        },
        cells: function(row, col) {
            const cellProperties = {};
            
            // First two columns are read-only
            if (col < 2) {
                cellProperties.readOnly = true;
            }
            
            return cellProperties;
        },
        beforeOnCellMouseOver: function(event, coords, TD) {
            // Prevent errors from cell hover
            if (!coords || coords.row < 0 || coords.col < 0) {
                return false;
            }
        }
    });
}

function updateTotals() {
    const data = hot.getData();
    
    data.forEach((row, rowIndex) => {
        let total = 0;
        
        // Sum from column 2 onwards (skip Nome and VALOR columns)
        for (let col = 2; col < row.length; col++) {
            const value = parsePercentage(row[col]);
            total += value;
        }
        
        hot.setDataAtCell(rowIndex, 1, formatPercentage(total), 'internal');
    });
}

function parsePercentage(value) {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        // Remove % sign and spaces, then parse
        return parseFloat(value.replace(/[%\s]/g, '').replace(',', '.')) || 0;
    }
    return 0;
}

function validateData() {
    const data = hot.getData();
    let hasErrors = false;
    let hasWarnings = false;
    const issues = [];
    
    data.forEach((row, rowIndex) => {
        const total = parsePercentage(row[1]);
        
        // Check if total is within tolerance (99.95% to 100.05%)
        if (total < 99.95 || total > 100.05) {
            hasErrors = true;
            issues.push(`${row[0]}: ${total.toFixed(2)}%`);
            
            // Highlight the total cell
            hot.setCellMeta(rowIndex, 1, 'className', 'htCenter validation-error');
        } else if (total < 99.98 || total > 100.02) {
            hasWarnings = true;
            hot.setCellMeta(rowIndex, 1, 'className', 'htCenter validation-warning');
        } else {
            hot.setCellMeta(rowIndex, 1, 'className', 'htCenter');
        }
    });
    
    hot.render();
    
    // Update validation status
    const statusDiv = document.getElementById('validation-status');
    const statusCard = statusDiv.querySelector('div');
    const icon = document.getElementById('validation-icon');
    const message = document.getElementById('validation-message');
    
    if (hasErrors) {
        statusDiv.classList.remove('hidden');
        statusCard.classList.remove('border-gray-800', 'border-yellow-500');
        statusCard.classList.add('border-red-500');
        icon.textContent = 'error';
        icon.className = 'material-symbols-outlined text-red-400';
        message.textContent = 'Erro: Alguns imóveis não somam 100% (±0.05%): ' + issues.join(', ');
        message.className = 'text-sm text-red-400';
    } else if (hasWarnings) {
        statusDiv.classList.remove('hidden');
        statusCard.classList.remove('border-gray-800', 'border-red-500');
        statusCard.classList.add('border-yellow-500');
        icon.textContent = 'warning';
        icon.className = 'material-symbols-outlined text-yellow-400';
        message.textContent = 'Aviso: Alguns valores estão próximos do limite (recomendado: 100% ±0.02%)';
        message.className = 'text-sm text-yellow-400';
    } else {
        statusDiv.classList.add('hidden');
    }
    
    return !hasErrors;
}

function validateAndSave() {
    if (!validateData()) {
        showToast('Corrija os erros antes de salvar', 'error');
        return;
    }
    
    openSaveModal();
}

function openSaveModal() {
    document.getElementById('save-modal').classList.remove('hidden');
    document.getElementById('save-modal').classList.add('flex');
    document.getElementById('save-form').reset();
}

function closeSaveModal() {
    document.getElementById('save-modal').classList.add('hidden');
    document.getElementById('save-modal').classList.remove('flex');
}

document.getElementById('save-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('version-name').value;
    const notes = document.getElementById('version-notes').value;
    
    // Build data structure
    const dados = {};
    const tableData = hot.getData();
    
    imoveis.forEach((imovel, index) => {
        dados[imovel.id] = {};
        
        proprietarios.forEach((prop, propIndex) => {
            const value = parsePercentage(tableData[index][propIndex + 2]);
            if (value > 0) {
                dados[imovel.id][prop.id] = value;
            }
        });
    });
    
    try {
        const result = await fetchWithAuth('/api/participacoes-versoes/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nome: name,
                dados_json: dados,
                observacoes: notes || null
            })
        });
        
        if (result) {
            showToast('Versão salva com sucesso!', 'success');
            closeSaveModal();
            await loadVersions();
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast(error.message || 'Erro ao salvar versão', 'error');
    }
});

document.getElementById('version-select').addEventListener('change', async (e) => {
    const versionId = e.target.value;
    
    if (!versionId) {
        // Reload current data
        await loadGridData();
        return;
    }
    
    try {
        const version = await fetchWithAuth(`/api/participacoes-versoes/${versionId}`);
        if (version) {
            // Parse and load version data
            const dados = JSON.parse(version.dados_json);
            
            const tableData = hot.getData();
            
            imoveis.forEach((imovel, index) => {
                const imovelData = dados[imovel.id.toString()] || {};
                
                proprietarios.forEach((prop, propIndex) => {
                    const value = imovelData[prop.id.toString()] || 0;
                    hot.setDataAtCell(index, propIndex + 2, formatPercentage(value), 'loadData');
                });
            });
            
            updateTotals();
            validateData();
            
            showToast(`Versão "${version.nome}" carregada`, 'info');
        }
    } catch (error) {
        console.error('Erro ao carregar versão:', error);
        showToast('Erro ao carregar versão', 'error');
    }
});

// Initialize on load - wait for DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    // DOM already loaded
    init();
}
</script>
{% endblock %}
