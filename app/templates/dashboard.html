{% extends "base.html" %}

{% block content %}
<div class="min-h-screen" style="background-color: #101622;">
    <!-- Navbar -->
    {% include "navbar.html" %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Filtros de Período -->
        <div class="rounded-lg shadow-lg p-4 mb-6" style="background-color: #1e293b;">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-400">calendar_today</span>
                    <span class="text-gray-300 font-medium">Período:</span>
                </div>
                <select id="ano-filter" class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-primary focus:outline-none">
                    <!-- Populated by JS -->
                </select>
                <button onclick="applyFilter()" class="bg-primary hover:bg-primary-hover text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">filter_alt</span>
                    Aplicar Filtro
                </button>
                <button onclick="refreshData()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                </button>
            </div>
        </div>

        <!-- Stats Cards with Animations -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
            <!-- Card 1: Total Imóveis -->
            <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-lg shadow-lg p-6 card-hover transform transition-all hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-200 text-sm font-medium">Total de Imóveis</p>
                        <p id="total-imoveis" class="text-4xl font-bold text-white mt-2">
                            <span class="loading-shimmer">-</span>
                        </p>
                        <p class="text-blue-200 text-xs mt-1">
                            <span id="imoveis-ativos" class="font-semibold">-</span> ativos
                        </p>
                    </div>
                    <div class="bg-blue-600 bg-opacity-50 rounded-full p-4">
                        <span class="material-symbols-outlined text-white text-3xl">home</span>
                    </div>
                </div>
            </div>

            <!-- Card 2: Proprietários -->
            <div class="bg-gradient-to-br from-green-900 to-green-700 rounded-lg shadow-lg p-6 card-hover transform transition-all hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-200 text-sm font-medium">Proprietários</p>
                        <p id="total-proprietarios" class="text-4xl font-bold text-white mt-2">
                            <span class="loading-shimmer">-</span>
                        </p>
                        <p class="text-green-200 text-xs mt-1">cadastrados</p>
                    </div>
                    <div class="bg-green-600 bg-opacity-50 rounded-full p-4">
                        <span class="material-symbols-outlined text-white text-3xl">person</span>
                    </div>
                </div>
            </div>

            <!-- Card 3: Valor Esperado -->
            <div class="bg-gradient-to-br from-purple-900 to-purple-700 rounded-lg shadow-lg p-6 card-hover transform transition-all hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-200 text-sm font-medium">Valor Esperado</p>
                        <p id="valor-esperado" class="text-4xl font-bold text-white mt-2">
                            <span class="loading-shimmer">R$ -</span>
                        </p>
                        <p class="text-purple-200 text-xs mt-1">
                            <span id="total-alugueis">-</span> aluguéis
                        </p>
                    </div>
                    <div class="bg-purple-600 bg-opacity-50 rounded-full p-4">
                        <span class="material-symbols-outlined text-white text-3xl">payments</span>
                    </div>
                </div>
            </div>

            <!-- Card 4: Valor Recebido -->
            <div class="bg-gradient-to-br from-orange-900 to-orange-700 rounded-lg shadow-lg p-6 card-hover transform transition-all hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-200 text-sm font-medium">Valor Recebido</p>
                        <p id="valor-recebido" class="text-4xl font-bold text-white mt-2">
                            <span class="loading-shimmer">R$ -</span>
                        </p>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="taxa-icon" class="material-symbols-outlined text-sm"></span>
                            <span id="taxa-recebimento" class="text-orange-200 text-sm font-semibold">-%</span>
                        </div>
                    </div>
                    <div class="bg-orange-600 bg-opacity-50 rounded-full p-4">
                        <span class="material-symbols-outlined text-white text-3xl">check_circle</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Gráfico de Evolução -->
            <div class="rounded-lg shadow-lg p-6" style="background-color: #1e293b;">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">show_chart</span>
                        Evolução Mensal
                    </h3>
                    <span class="text-gray-400 text-sm" id="ano-evolution">-</span>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>

            <!-- Gráfico de Distribuição -->
            <div class="rounded-lg shadow-lg p-6" style="background-color: #1e293b;">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">pie_chart</span>
                        Distribuição por Imóvel
                    </h3>
                    <span class="text-gray-400 text-sm">Top 10</span>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico de Barras Comparativo -->
        <div class="rounded-lg shadow-lg p-6 mb-8" style="background-color: #1e293b;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">bar_chart</span>
                    Comparativo: Esperado vs Recebido
                </h3>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-blue-500 rounded"></div>
                        <span class="text-gray-300 text-sm">Esperado</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                        <span class="text-gray-300 text-sm">Recebido</span>
                    </div>
                </div>
            </div>
            <div class="relative" style="height: 350px;">
                <canvas id="comparison-chart"></canvas>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let evolutionChart, distributionChart, comparisonChart;
let currentYear = new Date().getFullYear();

// Inicializar ano filter
function initYearFilter() {
    const select = document.getElementById('ano-filter');
    const startYear = 2020;
    const endYear = currentYear + 1;
    
    for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
    }
}

// Aplicar filtro
function applyFilter() {
    const year = document.getElementById('ano-filter').value;
    currentYear = parseInt(year);
    refreshData();
}

// Atualizar todos os dados
async function refreshData() {
    try {
        await Promise.all([
            loadStats(),
            loadEvolutionChart(),
            loadDistributionChart()
        ]);
    } catch (error) {
        console.error('Erro ao atualizar dados:', error);
    }
}

// Carregar estatísticas
async function loadStats() {
    try {
        const stats = await fetchWithAuth(`/api/dashboard/stats?ano=${currentYear}`);
        
        // Animar números
        animateNumber('total-imoveis', stats.total_imoveis);
        animateNumber('imoveis-ativos', stats.imoveis_ativos);
        animateNumber('total-proprietarios', stats.total_proprietarios);
        animateNumber('total-alugueis', stats.total_alugueis);
        
        // Valores monetários
        document.getElementById('valor-esperado').textContent = formatCurrency(stats.valor_total_esperado);
        document.getElementById('valor-recebido').textContent = formatCurrency(stats.valor_total_recebido);
        
        // Taxa de recebimento com ícone
        const taxa = stats.taxa_recebimento;
        const taxaEl = document.getElementById('taxa-recebimento');
        const iconEl = document.getElementById('taxa-icon');
        
        taxaEl.textContent = `${taxa.toFixed(1)}%`;
        
        if (taxa >= 90) {
            iconEl.textContent = 'trending_up';
            iconEl.className = 'material-symbols-outlined text-sm text-green-400';
            taxaEl.className = 'text-green-400 text-sm font-semibold';
        } else if (taxa >= 70) {
            iconEl.textContent = 'trending_flat';
            iconEl.className = 'material-symbols-outlined text-sm text-yellow-400';
            taxaEl.className = 'text-yellow-400 text-sm font-semibold';
        } else {
            iconEl.textContent = 'trending_down';
            iconEl.className = 'material-symbols-outlined text-sm text-red-400';
            taxaEl.className = 'text-red-400 text-sm font-semibold';
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Animar números
function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const duration = 1000; // 1 segundo
    const steps = 30;
    const stepValue = targetValue / steps;
    const stepTime = duration / steps;
    let current = 0;
    
    const interval = setInterval(() => {
        current += stepValue;
        if (current >= targetValue) {
            element.textContent = Math.round(targetValue);
            clearInterval(interval);
        } else {
            element.textContent = Math.round(current);
        }
    }, stepTime);
}

// Carregar gráfico de evolução
async function loadEvolutionChart() {
    try {
        const data = await fetchWithAuth(`/api/dashboard/evolution?ano=${currentYear}`);
        document.getElementById('ano-evolution').textContent = currentYear;
        
        const labels = data.map(d => d.mes_nome.substring(0, 3));
        const esperado = data.map(d => d.valor_esperado);
        const recebido = data.map(d => d.valor_recebido);
        
        if (evolutionChart) {
            evolutionChart.destroy();
        }
        
        const ctx = document.getElementById('evolution-chart').getContext('2d');
        evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Esperado',
                        data: esperado,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Recebido',
                        data: recebido,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: '#9CA3AF' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#9CA3AF',
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    }
                }
            }
        });
        
        // Atualizar gráfico de barras comparativo
        loadComparisonChart(data);
    } catch (error) {
        console.error('Erro ao carregar gráfico de evolução:', error);
    }
}

// Carregar gráfico de distribuição
async function loadDistributionChart() {
    try {
        const data = await fetchWithAuth(`/api/dashboard/distribution?ano=${currentYear}&limit=10`);
        
        if (data.length === 0) {
            console.log('Sem dados para distribuição');
            return;
        }
        
        const labels = data.map(d => d.imovel_nome);
        const values = data.map(d => d.valor_total);
        
        // Cores vibrantes
        const colors = [
            'rgb(59, 130, 246)',   // blue
            'rgb(34, 197, 94)',    // green
            'rgb(249, 115, 22)',   // orange
            'rgb(168, 85, 247)',   // purple
            'rgb(236, 72, 153)',   // pink
            'rgb(14, 165, 233)',   // sky
            'rgb(234, 179, 8)',    // yellow
            'rgb(239, 68, 68)',    // red
            'rgb(20, 184, 166)',   // teal
            'rgb(163, 230, 53)',   // lime
        ];
        
        if (distributionChart) {
            distributionChart.destroy();
        }
        
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        distributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#1e293b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            color: '#9CA3AF',
                            font: { size: 11 },
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gráfico de distribuição:', error);
    }
}

// Carregar gráfico de barras comparativo
function loadComparisonChart(evolutionData) {
    try {
        const labels = evolutionData.map(d => d.mes_nome.substring(0, 3));
        const esperado = evolutionData.map(d => d.valor_esperado);
        const recebido = evolutionData.map(d => d.valor_recebido);
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        const ctx = document.getElementById('comparison-chart').getContext('2d');
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Esperado',
                        data: esperado,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: 'Recebido',
                        data: recebido,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#9CA3AF',
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { display: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gráfico comparativo:', error);
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    initYearFilter();
    refreshData();
});
</script>
{% endblock %}
