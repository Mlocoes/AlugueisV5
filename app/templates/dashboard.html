{% extends "base.html" %}

{% block content %}
<div class="h-screen flex flex-col overflow-hidden" style="background-color: #101622;">
    <!-- Navbar -->
    {% include "navbar.html" %}

    <style>
    /* Container principal do dashboard - altura fixa sem scroll */
    .dashboard-main {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        gap: 0.75rem;
    }
    
    /* Filtros compactos */
    .filter-bar {
        background-color: #1e293b;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }
    
    /* Cards de stats - altura reduzida */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        flex-shrink: 0;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--from), var(--to));
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    /* Gráficos - otimizado para espaço disponível */
    .charts-container {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: 1fr 1fr;
        gap: 0.75rem;
        min-height: 0;
    }
    
    .chart-card {
        background-color: #1e293b;
        border-radius: 0.5rem;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    .chart-card.full-width {
        grid-column: span 2;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        flex-shrink: 0;
    }
    
    .chart-content {
        flex: 1;
        min-height: 0;
        position: relative;
    }
    
    .chart-content canvas {
        width: 100% !important;
        height: 100% !important;
    }
    </style>

    <!-- Main Content -->
    <div class="dashboard-main">
        <!-- Filtros Compactos -->
        <div class="filter-bar">
            <span class="material-symbols-outlined text-gray-400 text-lg">calendar_today</span>
            <span class="text-gray-300 font-medium text-sm">Período:</span>
            <select id="mes-filter" class="bg-gray-700 text-white px-2 py-1 text-sm rounded border border-gray-600 focus:border-primary focus:outline-none" onchange="applyFilter()">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <select id="ano-filter" class="bg-gray-700 text-white px-2 py-1 text-sm rounded border border-gray-600 focus:border-primary focus:outline-none" onchange="applyFilter()">
                <!-- Populated by JS -->
            </select>
            <button onclick="refreshData()" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded transition-colors ml-auto">
                <span class="material-symbols-outlined text-sm">refresh</span>
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <!-- Card 1: Proprietários -->
            <div class="stat-card" style="--from: #16a34a; --to: #15803d;">
                <div>
                    <p class="text-white text-opacity-80 text-xs font-medium">Proprietários</p>
                    <p id="total-proprietarios" class="text-2xl font-bold text-white mt-1">-</p>
                    <p class="text-white text-opacity-70 text-xs">cadastrados</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <span class="material-symbols-outlined text-white text-2xl">person</span>
                </div>
            </div>

            <!-- Card 2: Valor Esperado -->
            <div class="stat-card" style="--from: #9333ea; --to: #7e22ce;">
                <div>
                    <p class="text-white text-opacity-80 text-xs font-medium">Valor Esperado (Mês)</p>
                    <p id="valor-esperado" class="text-2xl font-bold text-white mt-1">R$ -</p>
                    <p class="text-white text-opacity-70 text-xs"><span id="periodo-esperado">em Novembro</span> | <span id="total-alugueis">0</span> aluguéis</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <span class="material-symbols-outlined text-white text-2xl">payments</span>
                </div>
            </div>

            <!-- Card 3: Valor Recebido -->
            <div class="stat-card" style="--from: #ea580c; --to: #c2410c;">
                <div>
                    <p class="text-white text-opacity-80 text-xs font-medium">Valor Recebido (Ano)</p>
                    <p id="valor-recebido" class="text-2xl font-bold text-white mt-1">R$ -</p>
                    <div class="flex items-center gap-1 mt-1">
                        <span id="taxa-icon" class="material-symbols-outlined text-xs"></span>
                        <span id="taxa-recebimento" class="text-white text-opacity-90 text-xs font-semibold">-%</span>
                        <span class="text-white text-opacity-70 text-xs">do ano</span>
                    </div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <span class="material-symbols-outlined text-white text-2xl">check_circle</span>
                </div>
            </div>

            <!-- Card 4: Imóveis -->
            <div class="stat-card" style="--from: #2563eb; --to: #1e40af;">
                <div>
                    <p class="text-white text-opacity-80 text-xs font-medium">Imóveis Disponíveis</p>
                    <p id="imoveis-disponiveis" class="text-2xl font-bold text-white mt-1">-</p>
                    <p class="text-white text-opacity-70 text-xs">de <span id="total-imoveis">-</span> cadastrados</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <span class="material-symbols-outlined text-white text-2xl">home</span>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="charts-container">
            <!-- Evolução Mensal -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="text-sm font-bold text-white flex items-center gap-1">
                        <span class="material-symbols-outlined text-primary text-lg">show_chart</span>
                        Evolução Mensal
                    </h3>
                    <span class="text-gray-400 text-xs" id="ano-evolution">2025</span>
                </div>
                <div class="chart-content">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>

            <!-- Distribuição por Imóvel -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="text-sm font-bold text-white flex items-center gap-1">
                        <span class="material-symbols-outlined text-primary text-lg">pie_chart</span>
                        Distribuição por Imóvel
                    </h3>
                    <span class="text-gray-400 text-xs">Top 10</span>
                </div>
                <div class="chart-content">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </div>

            <!-- Comparativo: Esperado vs Recebido -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3 class="text-sm font-bold text-white flex items-center gap-1">
                        <span class="material-symbols-outlined text-primary text-lg">bar_chart</span>
                        Comparativo: Esperado vs Recebido
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 bg-blue-500 rounded"></div>
                            <span class="text-gray-300 text-xs">Esperado</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 bg-green-500 rounded"></div>
                            <span class="text-gray-300 text-xs">Recebido</span>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let evolutionChart, distributionChart, comparisonChart;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1; // 1-12 (mês atual)

// Inicializar ano filter
function initYearFilter() {
    const select = document.getElementById('ano-filter');
    const startYear = 2020;
    const endYear = currentYear + 1;
    
    for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
    }
    
    // Inicializar mês atual
    const mesSelect = document.getElementById('mes-filter');
    mesSelect.value = currentMonth;
}

// Aplicar filtro (chamado automaticamente ao mudar seleção)
function applyFilter() {
    const year = document.getElementById('ano-filter').value;
    const month = document.getElementById('mes-filter').value;
    currentYear = parseInt(year);
    currentMonth = parseInt(month);
    refreshData();
}

// Atualizar todos os dados
async function refreshData() {
    try {
        await Promise.all([
            loadStats(),
            loadEvolutionChart(),
            loadDistributionChart()
        ]);
    } catch (error) {
        console.error('Erro ao atualizar dados:', error);
    }
}

// Carregar estatísticas
async function loadStats() {
    try {
        // Sempre enviar ano e mês
        const url = `/api/dashboard/stats?ano=${currentYear}&mes=${currentMonth}`;
        
        const stats = await fetchWithAuth(url);
        
        // Atualizar label do período de "Valor Esperado"
        const mesesNomes = [
            '', 'em Janeiro', 'em Fevereiro', 'em Março', 'em Abril', 'em Maio', 'em Junho',
            'em Julho', 'em Agosto', 'em Setembro', 'em Outubro', 'em Novembro', 'em Dezembro'
        ];
        document.getElementById('periodo-esperado').textContent = mesesNomes[currentMonth];
        
        // Animar números
        animateNumber('imoveis-disponiveis', stats.imoveis_disponiveis);
        animateNumber('total-imoveis', stats.total_imoveis);
        animateNumber('total-proprietarios', stats.total_proprietarios);
        animateNumber('total-alugueis', stats.total_alugueis);
        
        // Valores monetários
        document.getElementById('valor-esperado').textContent = formatCurrency(stats.valor_total_esperado);
        document.getElementById('valor-recebido').textContent = formatCurrency(stats.valor_total_recebido);
        
        // Taxa de recebimento com ícone
        const taxa = stats.taxa_recebimento;
        const taxaEl = document.getElementById('taxa-recebimento');
        const iconEl = document.getElementById('taxa-icon');
        
        taxaEl.textContent = `${taxa.toFixed(1)}%`;
        
        if (taxa >= 90) {
            iconEl.textContent = 'trending_up';
            iconEl.className = 'material-symbols-outlined text-sm text-green-400';
            taxaEl.className = 'text-green-400 text-sm font-semibold';
        } else if (taxa >= 70) {
            iconEl.textContent = 'trending_flat';
            iconEl.className = 'material-symbols-outlined text-sm text-yellow-400';
            taxaEl.className = 'text-yellow-400 text-sm font-semibold';
        } else {
            iconEl.textContent = 'trending_down';
            iconEl.className = 'material-symbols-outlined text-sm text-red-400';
            taxaEl.className = 'text-red-400 text-sm font-semibold';
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Animar números
function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const duration = 1000; // 1 segundo
    const steps = 30;
    const stepValue = targetValue / steps;
    const stepTime = duration / steps;
    let current = 0;
    
    const interval = setInterval(() => {
        current += stepValue;
        if (current >= targetValue) {
            element.textContent = Math.round(targetValue);
            clearInterval(interval);
        } else {
            element.textContent = Math.round(current);
        }
    }, stepTime);
}

// Carregar gráfico de evolução
async function loadEvolutionChart() {
    try {
        const data = await fetchWithAuth(`/api/dashboard/evolution?ano=${currentYear}`);
        document.getElementById('ano-evolution').textContent = currentYear;
        
        const labels = data.map(d => d.mes_nome.substring(0, 3));
        const esperado = data.map(d => d.valor_esperado);
        const recebido = data.map(d => d.valor_recebido);
        
        if (evolutionChart) {
            evolutionChart.destroy();
        }
        
        const ctx = document.getElementById('evolution-chart').getContext('2d');
        evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Esperado',
                        data: esperado,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Recebido',
                        data: recebido,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: '#9CA3AF' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#9CA3AF',
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    }
                }
            }
        });
        
        // Atualizar gráfico de barras comparativo
        loadComparisonChart(data);
    } catch (error) {
        console.error('Erro ao carregar gráfico de evolução:', error);
    }
}

// Carregar gráfico de distribuição
async function loadDistributionChart() {
    try {
        const data = await fetchWithAuth(`/api/dashboard/distribution?ano=${currentYear}&limit=10`);
        
        if (data.length === 0) {
            console.log('Sem dados para distribuição');
            return;
        }
        
        const labels = data.map(d => d.imovel_nome);
        const values = data.map(d => d.valor_total);
        
        // Cores vibrantes
        const colors = [
            'rgb(59, 130, 246)',   // blue
            'rgb(34, 197, 94)',    // green
            'rgb(249, 115, 22)',   // orange
            'rgb(168, 85, 247)',   // purple
            'rgb(236, 72, 153)',   // pink
            'rgb(14, 165, 233)',   // sky
            'rgb(234, 179, 8)',    // yellow
            'rgb(239, 68, 68)',    // red
            'rgb(20, 184, 166)',   // teal
            'rgb(163, 230, 53)',   // lime
        ];
        
        if (distributionChart) {
            distributionChart.destroy();
        }
        
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        distributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#1e293b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            color: '#9CA3AF',
                            font: { size: 11 },
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gráfico de distribuição:', error);
    }
}

// Carregar gráfico de barras comparativo
function loadComparisonChart(evolutionData) {
    try {
        const labels = evolutionData.map(d => d.mes_nome.substring(0, 3));
        const esperado = evolutionData.map(d => d.valor_esperado);
        const recebido = evolutionData.map(d => d.valor_recebido);
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        const ctx = document.getElementById('comparison-chart').getContext('2d');
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Esperado',
                        data: esperado,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: 'Recebido',
                        data: recebido,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#9CA3AF',
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(156, 163, 175, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { display: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar gráfico comparativo:', error);
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    initYearFilter();
    refreshData();
});
</script>
{% endblock %}
