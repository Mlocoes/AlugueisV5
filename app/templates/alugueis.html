{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-bg-dark">
    <!-- Navbar -->
    <nav class="bg-[var(--card-dark)] shadow-lg mb-6">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-8">
                    <h1 class="text-2xl font-bold text-[var(--primary)]">AlugueisV5</h1>
                    <div class="flex gap-6">
                        <a href="/dashboard" class="nav-link">
                            <span class="material-symbols-outlined text-sm">dashboard</span>
                            Dashboard
                        </a>
                        <a href="/proprietarios" class="nav-link">
                            <span class="material-symbols-outlined text-sm">person</span>
                            Proprietários
                        </a>
                        <a href="/imoveis" class="nav-link">
                            <span class="material-symbols-outlined text-sm">home</span>
                            Imóveis
                        </a>
                        <a href="/participacoes" class="nav-link">
                            <span class="material-symbols-outlined text-sm">pie_chart</span>
                            Participações
                        </a>
                        <a href="/alugueis" class="nav-link active">
                            <span class="material-symbols-outlined text-sm">payments</span>
                            Aluguéis
                        </a>
                        <a href="/relatorios" class="nav-link">
                            <span class="material-symbols-outlined text-sm">assessment</span>
                            Relatórios
                        </a>
                        <a href="/usuarios" class="nav-link">
                            <span class="material-symbols-outlined text-sm">group</span>
                            Usuários
                        </a>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined">logout</span>
                    <span class="hidden md:inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pb-8">

<!-- Modal Novo/Editar Aluguel -->
<div id="modal-aluguel" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4">
    <div class="bg-card-dark rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Novo Aluguel</h3>
                <button id="btn-fechar-modal" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="form-aluguel">
                <input type="hidden" id="aluguel-id">

                <!-- Imóvel e Mês -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Imóvel *</label>
                        <select id="aluguel-imovel" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione o imóvel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Mês de Referência *</label>
                        <input type="month" id="aluguel-mes" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>

                <!-- Valores Principais -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Valores</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluguel</label>
                            <input type="number" step="0.01" id="aluguel-valor-aluguel" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Condomínio</label>
                            <input type="number" step="0.01" id="aluguel-valor-condominio" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">IPTU</label>
                            <input type="number" step="0.01" id="aluguel-valor-iptu" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Luz</label>
                            <input type="number" step="0.01" id="aluguel-valor-luz" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Água</label>
                            <input type="number" step="0.01" id="aluguel-valor-agua" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Gás</label>
                            <input type="number" step="0.01" id="aluguel-valor-gas" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Internet</label>
                            <input type="number" step="0.01" id="aluguel-valor-internet" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Outros</label>
                            <input type="number" step="0.01" id="aluguel-valor-outros" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex items-end">
                            <div class="w-full bg-primary/20 border border-primary rounded-lg px-4 py-2">
                                <div class="text-xs text-gray-400">Total</div>
                                <div class="text-lg font-bold text-white" id="aluguel-total-preview">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status de Pagamento -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Status de Pagamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="aluguel-pago" class="w-5 h-5 text-primary bg-bg-dark border-border-dark rounded focus:ring-primary">
                            <label for="aluguel-pago" class="ml-2 text-gray-300">Marcar como pago</label>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data de Pagamento</label>
                            <input type="date" id="aluguel-data-pagamento" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Observações</label>
                    <textarea id="aluguel-observacoes" rows="3" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Observações sobre este aluguel..."></textarea>
                </div>

                <!-- Botões -->
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors">
                        Salvar Aluguel
                    </button>
                    <button type="button" id="btn-cancelar-modal" class="px-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let alugueisData = [];
let imoveisData = [];

// Carregar informações do usuário
async function loadUserInfo() {
    try {
        const user = await fetchWithAuth('/api/auth/me');
        if (user) {
            document.getElementById('user-name').textContent = user.nome;
        }
    } catch (error) {
        console.error('Erro ao carregar usuário:', error);
    }
}

// Carregar imóveis para os selects
async function loadImoveis() {
    try {
        imoveisData = await fetchWithAuth('/api/imoveis/?is_active=true&limit=1000');
        if (imoveisData) {
            
            const selectFiltro = document.getElementById('filter-imovel');
            const selectModal = document.getElementById('aluguel-imovel');
            
            selectFiltro.innerHTML = '<option value="">Todos os imóveis</option>';
            selectModal.innerHTML = '<option value="">Selecione o imóvel</option>';
            
            imoveisData.forEach(imovel => {
                const option1 = document.createElement('option');
                option1.value = imovel.id;
                option1.textContent = `${imovel.nome} - ${imovel.endereco}`;
                selectFiltro.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = imovel.id;
                option2.textContent = `${imovel.nome} - ${imovel.endereco}`;
                selectModal.appendChild(option2);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar imóveis:', error);
    }
}

// Carregar anos disponíveis
function loadAnos() {
    const selectAno = document.getElementById('filter-ano');
    const anoAtual = new Date().getFullYear();
    
    for (let ano = anoAtual; ano >= anoAtual - 5; ano--) {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
    }
    
    // Selecionar ano atual por padrão
    selectAno.value = anoAtual;
}

// Carregar estatísticas
async function loadStats() {
    try {
        const ano = document.getElementById('filter-ano').value;
        const url = ano ? `/api/alugueis/stats/summary?ano=${ano}` : '/api/alugueis/stats/summary';
        
        const response = await fetchWithAuth(url);
        if (response && response.ok) {
            const stats = await response.json();
            document.getElementById('stat-total').textContent = stats.total_alugueis;
            document.getElementById('stat-pagos').textContent = stats.pagos;
            document.getElementById('stat-pendentes').textContent = stats.pendentes;
            document.getElementById('stat-recebido').textContent = formatCurrency(stats.valor_total_recebido);
            document.getElementById('stat-pendente').textContent = formatCurrency(stats.valor_total_pendente);
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Carregar aluguéis
async function loadAlugueis() {
    const tbody = document.getElementById('alugueis-tbody');
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('empty-state');
    
    tbody.innerHTML = '';
    loading.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    try {
        // Construir URL com filtros
        const params = new URLSearchParams();
        
        const mes = document.getElementById('filter-mes').value;
        const imovelId = document.getElementById('filter-imovel').value;
        const ano = document.getElementById('filter-ano').value;
        const status = document.getElementById('filter-status').value;
        
        if (mes) params.append('mes_referencia', mes);
        if (imovelId) params.append('imovel_id', imovelId);
        if (ano && !mes) params.append('ano', ano);
        if (status !== '') params.append('pago', status);
        
        params.append('limit', '1000');
        
        const response = await fetchWithAuth(`/api/alugueis/?${params}`);
        if (response && response.ok) {
            alugueisData = await response.json();
            
            if (alugueisData.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                alugueisData.forEach(aluguel => {
                    const row = createAluguelRow(aluguel);
                    tbody.appendChild(row);
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar aluguéis:', error);
        showToast('Erro ao carregar aluguéis', 'error');
    } finally {
        loading.classList.add('hidden');
    }
}

// Criar linha da tabela
function createAluguelRow(aluguel) {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-bg-dark transition-colors';
    
    const encargos = aluguel.valor_condominio + aluguel.valor_iptu + aluguel.valor_luz + 
                     aluguel.valor_agua + aluguel.valor_gas + aluguel.valor_internet + aluguel.outros_valores;
    
    const mesFormatado = formatarMes(aluguel.mes_referencia);
    const statusBadge = aluguel.pago 
        ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400">Pago</span>'
        : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-400">Pendente</span>';
    
    tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-medium">${mesFormatado}</td>
        <td class="px-6 py-4 text-sm text-gray-300">
            <div class="font-medium">${aluguel.imovel_nome || 'N/A'}</div>
            <div class="text-xs text-gray-500">${aluguel.imovel_endereco || ''}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-white">${formatCurrency(aluguel.valor_aluguel)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-300">${formatCurrency(encargos)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-white">${formatCurrency(aluguel.valor_total)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center">${statusBadge}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
            <button onclick="editarAluguel(${aluguel.id})" class="text-primary hover:text-blue-400 mr-3" title="Editar">
                <span class="material-symbols-outlined text-lg">edit</span>
            </button>
            <button onclick="deletarAluguel(${aluguel.id})" class="text-red-500 hover:text-red-400" title="Excluir">
                <span class="material-symbols-outlined text-lg">delete</span>
            </button>
        </td>
    `;
    
    return tr;
}

// Formatar mês (2025-11 -> Nov/2025)
function formatarMes(mesRef) {
    const [ano, mes] = mesRef.split('-');
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    return `${meses[parseInt(mes) - 1]}/${ano}`;
}

// Abrir modal para novo aluguel
function abrirModalNovo() {
    document.getElementById('modal-title').textContent = 'Novo Aluguel';
    document.getElementById('form-aluguel').reset();
    document.getElementById('aluguel-id').value = '';
    document.getElementById('aluguel-total-preview').textContent = 'R$ 0,00';
    
    // Definir mês atual
    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('aluguel-mes').value = mesAtual;
    
    const modal = document.getElementById('modal-aluguel');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Editar aluguel
async function editarAluguel(id) {
    try {
        const aluguel = await fetchWithAuth(`/api/alugueis/${id}`);
        if (aluguel) {
            
            document.getElementById('modal-title').textContent = 'Editar Aluguel';
            document.getElementById('aluguel-id').value = aluguel.id;
            document.getElementById('aluguel-imovel').value = aluguel.imovel_id;
            document.getElementById('aluguel-mes').value = aluguel.mes_referencia;
            document.getElementById('aluguel-valor-aluguel').value = aluguel.valor_aluguel;
            document.getElementById('aluguel-valor-condominio').value = aluguel.valor_condominio;
            document.getElementById('aluguel-valor-iptu').value = aluguel.valor_iptu;
            document.getElementById('aluguel-valor-luz').value = aluguel.valor_luz;
            document.getElementById('aluguel-valor-agua').value = aluguel.valor_agua;
            document.getElementById('aluguel-valor-gas').value = aluguel.valor_gas;
            document.getElementById('aluguel-valor-internet').value = aluguel.valor_internet;
            document.getElementById('aluguel-valor-outros').value = aluguel.outros_valores;
            document.getElementById('aluguel-pago').checked = aluguel.pago;
            document.getElementById('aluguel-data-pagamento').value = aluguel.data_pagamento || '';
            document.getElementById('aluguel-observacoes').value = aluguel.observacoes || '';
            
            atualizarTotalPreview();
            const modal = document.getElementById('modal-aluguel');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    } catch (error) {
        console.error('Erro ao carregar aluguel:', error);
        showToast('Erro ao carregar aluguel', 'error');
    }
}

// Deletar aluguel
async function deletarAluguel(id) {
    if (!confirm('Tem certeza que deseja excluir este aluguel?')) return;
    
    try {
        const response = await fetchWithAuth(`/api/alugueis/${id}`, {
            method: 'DELETE'
        });
        
        if (response && (response.ok || response.status === 204)) {
            showToast('Aluguel excluído com sucesso!', 'success');
            loadAlugueis();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao excluir aluguel', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir aluguel:', error);
        showToast('Erro ao excluir aluguel', 'error');
    }
}

// Atualizar preview do total
function atualizarTotalPreview() {
    const valores = [
        'aluguel-valor-aluguel', 'aluguel-valor-condominio', 'aluguel-valor-iptu',
        'aluguel-valor-luz', 'aluguel-valor-agua', 'aluguel-valor-gas',
        'aluguel-valor-internet', 'aluguel-valor-outros'
    ];
    
    let total = 0;
    valores.forEach(id => {
        const valor = parseFloat(document.getElementById(id).value) || 0;
        total += valor;
    });
    
    document.getElementById('aluguel-total-preview').textContent = formatCurrency(total);
}

// Salvar aluguel
async function salvarAluguel(event) {
    event.preventDefault();
    
    const id = document.getElementById('aluguel-id').value;
    const isEdit = id !== '';
    
    const data = {
        imovel_id: parseInt(document.getElementById('aluguel-imovel').value),
        mes_referencia: document.getElementById('aluguel-mes').value,
        valor_aluguel: parseFloat(document.getElementById('aluguel-valor-aluguel').value) || 0,
        valor_condominio: parseFloat(document.getElementById('aluguel-valor-condominio').value) || 0,
        valor_iptu: parseFloat(document.getElementById('aluguel-valor-iptu').value) || 0,
        valor_luz: parseFloat(document.getElementById('aluguel-valor-luz').value) || 0,
        valor_agua: parseFloat(document.getElementById('aluguel-valor-agua').value) || 0,
        valor_gas: parseFloat(document.getElementById('aluguel-valor-gas').value) || 0,
        valor_internet: parseFloat(document.getElementById('aluguel-valor-internet').value) || 0,
        outros_valores: parseFloat(document.getElementById('aluguel-valor-outros').value) || 0,
        pago: document.getElementById('aluguel-pago').checked,
        data_pagamento: document.getElementById('aluguel-data-pagamento').value || null,
        observacoes: document.getElementById('aluguel-observacoes').value || null
    };
    
    try {
        const url = isEdit ? `/api/alugueis/${id}` : '/api/alugueis/';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetchWithAuth(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        if (response && (response.ok || response.status === 201)) {
            showToast(`Aluguel ${isEdit ? 'atualizado' : 'criado'} com sucesso!`, 'success');
            fecharModal();
            loadAlugueis();
            loadStats();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao salvar aluguel', 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar aluguel:', error);
        showToast('Erro ao salvar aluguel', 'error');
    }
}

// Fechar modal
function fecharModal() {
    const modal = document.getElementById('modal-aluguel');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    loadUserInfo();
    loadAnos();
    loadImoveis();
    loadStats();
    loadAlugueis();
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => logout());
    
    // Botões
    document.getElementById('btn-novo-aluguel').addEventListener('click', abrirModalNovo);
    document.getElementById('btn-filtrar').addEventListener('click', () => {
        loadAlugueis();
        loadStats();
    });
    document.getElementById('btn-limpar-filtros').addEventListener('click', () => {
        document.getElementById('filter-mes').value = '';
        document.getElementById('filter-imovel').value = '';
        document.getElementById('filter-status').value = '';
        const anoAtual = new Date().getFullYear();
        document.getElementById('filter-ano').value = anoAtual;
        loadAlugueis();
        loadStats();
    });
    
    // Modal
    document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
    document.getElementById('btn-cancelar-modal').addEventListener('click', fecharModal);
    document.getElementById('form-aluguel').addEventListener('submit', salvarAluguel);
    
    // Atualizar preview ao digitar valores
    const valorInputs = [
        'aluguel-valor-aluguel', 'aluguel-valor-condominio', 'aluguel-valor-iptu',
        'aluguel-valor-luz', 'aluguel-valor-agua', 'aluguel-valor-gas',
        'aluguel-valor-internet', 'aluguel-valor-outros'
    ];
    
    valorInputs.forEach(id => {
        document.getElementById(id).addEventListener('input', atualizarTotalPreview);
    });
    
    // Fechar modal ao clicar fora
    document.getElementById('modal-aluguel').addEventListener('click', (e) => {
        if (e.target.id === 'modal-aluguel') {
            fecharModal();
        }
    });
});
</script>
{% endblock %}
