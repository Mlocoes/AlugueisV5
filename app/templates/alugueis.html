{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css" />
<style>
    /* Container principal sem scroll */
    .alugueis-container {
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Área de conteúdo scrollável */
    .alugueis-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1rem;
    }
    
    .htDarkTable .handsontable td,
    .htDarkTable .handsontable th {
        background-color: var(--card-dark);
        color: #f9fafb;
        border-color: #334155;
    }

    .htDarkTable .handsontable thead th {
        background-color: var(--bg-dark);
        font-weight: 600;
    }

    .htDarkTable .handsontable .negative-value {
        color: #f87171 !important;
    }

    #alugueis-handsontable {
        height: calc(100vh - 250px);
        width: 100%;
    }

    .handsontable .htRight {
        text-align: right;
    }

    .handsontable .htLeft {
        text-align: left;
    }

    .htDarkTable .wtHolder {
        border: 1px solid #334155;
        border-radius: 8px;
        overflow: hidden;
    }

    .htDarkTable .handsontable tbody tr:hover td {
        background-color: rgba(148, 163, 184, 0.08);
    }

    .htDarkTable .handsontable .htBorder.current {
        border-color: var(--primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="alugueis-container bg-bg-dark">
    <!-- Navbar -->
    {% include "navbar.html" %}

    <!-- Main Content -->
    <div class="alugueis-content">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Aluguéis Mensais</h2>
        </div>

        <!-- Filtros -->
        <div class="bg-card-dark rounded-lg p-3 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Ano</label>
                    <select id="filter-ano" class="w-full bg-bg-dark border border-border-dark text-white text-sm rounded-lg px-2 py-1.5">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Mês</label>
                    <select id="filter-mes" class="w-full bg-bg-dark border border-border-dark text-white text-sm rounded-lg px-2 py-1.5">
                        <option value="">Todos</option>
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Imóvel</label>
                    <select id="filter-imovel" class="w-full bg-bg-dark border border-border-dark text-white text-sm rounded-lg px-2 py-1.5">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Status</label>
                    <select id="filter-status" class="w-full bg-bg-dark border border-border-dark text-white text-sm rounded-lg px-2 py-1.5">
                        <option value="">Todos</option>
                        <option value="true">Pago</option>
                        <option value="false">Pendente</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Grid Handsontable -->
        <div class="bg-card-dark rounded-lg p-4 htDarkTable">
            <div class="flex flex-col gap-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <p class="text-sm text-gray-400">Dê um duplo clique em um imóvel para editar.</p>
                    <div class="flex gap-2">
                    </div>
                </div>
                <div class="relative">
                    <div id="alugueis-loading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-bg-dark/70 backdrop-blur-sm" style="display: none;">
                        <div class="animate-spin rounded-full h-10 w-10 border-2 border-primary border-t-transparent"></div>
                        <p class="mt-4 text-gray-300 text-sm">Carregando aluguéis...</p>
                    </div>
                    <div id="alugueis-empty" class="hidden py-12 text-center text-gray-400 text-sm">
                        <span class="material-symbols-outlined text-5xl block mb-3">inbox</span>
                        Nenhum aluguel encontrado para os filtros selecionados.
                    </div>
                    <div id="alugueis-handsontable"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Novo/Editar Aluguel -->
<div id="modal-aluguel" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4">
    <div class="bg-card-dark rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Novo Aluguel</h3>
                <button id="btn-fechar-modal" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="form-aluguel">
                <input type="hidden" id="aluguel-id">

                <!-- Imóvel e Mês -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Imóvel *</label>
                        <select id="aluguel-imovel" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione o imóvel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Mês de Referência *</label>
                        <input type="month" id="aluguel-mes" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>

                <!-- Valor Total -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Valor</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Valor Total do Aluguel (R$) *</label>
                            <input type="number" step="0.01" id="aluguel-valor-total" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex items-end">
                            <div class="w-full bg-primary/20 border border-primary rounded-lg px-4 py-2">
                                <div class="text-xs text-gray-400">Valor</div>
                                <div class="text-lg font-bold text-white" id="aluguel-total-preview">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status de Pagamento -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Status de Pagamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="aluguel-pago" class="w-5 h-5 text-primary bg-bg-dark border-border-dark rounded focus:ring-primary">
                            <label for="aluguel-pago" class="ml-2 text-gray-300">Marcar como pago</label>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors">
                        Salvar Aluguel
                    </button>
                    <button type="button" id="btn-cancelar-modal" class="px-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
<script>
console.log('=== ALUGUEIS.HTML: Script carregado ===');

let alugueisHot = null;
let alugueisGridRows = [];
let proprietariosGrid = [];
let selectedAluguelIndex = null;
let imoveisData = [];

function formatCurrencyPlain(value) {
    const numericValue = typeof value === 'number' ? value : parseFloat(value) || 0;
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericValue);
}

function getSelectedAluguel() {
    if (selectedAluguelIndex === null) return null;
    return alugueisGridRows[selectedAluguelIndex] || null;
}

// Carregar informações do usuário
// Carregar imóveis para os selects
async function loadImoveis() {
    console.log('loadImoveis: iniciando');
    try {
        imoveisData = await fetchWithAuth('/api/imoveis/?is_active=true&limit=1000');
        if (imoveisData) {
            
            const selectFiltro = document.getElementById('filter-imovel');
            const selectModal = document.getElementById('aluguel-imovel');
            
            if (selectFiltro) {
                selectFiltro.innerHTML = '<option value="">Todos os imóveis</option>';
                imoveisData.forEach(imovel => {
                    const option = document.createElement('option');
                    option.value = imovel.id;
                    option.textContent = `${imovel.nome} - ${imovel.endereco}`;
                    selectFiltro.appendChild(option);
                });
            }
            
            if (selectModal) {
                selectModal.innerHTML = '<option value="">Selecione o imóvel</option>';
                imoveisData.forEach(imovel => {
                    const option = document.createElement('option');
                    option.value = imovel.id;
                    option.textContent = `${imovel.nome} - ${imovel.endereco}`;
                    selectModal.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar imóveis:', error);
        showToast('Erro ao carregar imóveis', 'error');
    }
}

async function loadAnos() {
    console.log('loadAnos: iniciando');
    try {
        const alugueis = await fetchWithAuth('/api/alugueis/?limit=1000');
        if (alugueis) {
            const anos = new Set();
            alugueis.forEach(aluguel => {
                if (aluguel.mes_referencia) {
                    const ano = aluguel.mes_referencia.split('-')[0];
                    anos.add(ano);
                }
            });
            
            const selectAno = document.getElementById('filter-ano');
            if (selectAno) {
                selectAno.innerHTML = '<option value="">Todos os anos</option>';
                Array.from(anos).sort().reverse().forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    selectAno.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar anos:', error);
        showToast('Erro ao carregar anos', 'error');
    }
}

// Carregar estatísticas
async function loadStats() {
    try {
        const stats = await fetchWithAuth('/api/alugueis/stats/summary');
        if (!stats) return;

        const statElements = {
            'stat-total': stats.total_alugueis,
            'stat-pagos': stats.pagos,
            'stat-pendentes': stats.pendentes,
            'stat-recebido': formatCurrency(stats.valor_total_recebido),
            'stat-pendente': formatCurrency(stats.valor_total_pendente)
        };

        for (const [id, value] of Object.entries(statElements)) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Carregar aluguéis
async function loadAlugueis() {
    console.log('loadAlugueis: iniciando');
    const container = document.getElementById('alugueis-handsontable');
    const loadingOverlay = document.getElementById('alugueis-loading');
    const emptyState = document.getElementById('alugueis-empty');

    if (!container) {
        console.warn('Container Handsontable não encontrado');
        return;
    }

    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
    if (emptyState) emptyState.classList.add('hidden');

    selectedAluguelIndex = null;
    alugueisGridRows = [];
    proprietariosGrid = [];

    if (alugueisHot) {
        alugueisHot.destroy();
        alugueisHot = null;
    }
    container.innerHTML = '';

    try {
        const params = new URLSearchParams();

        const ano = document.getElementById('filter-ano')?.value;
        const mes = document.getElementById('filter-mes')?.value;
        const imovelId = document.getElementById('filter-imovel')?.value;
        const status = document.getElementById('filter-status')?.value;

        // Combinar ano e mês se ambos estiverem selecionados
        if (ano && mes) {
            params.append('mes_referencia', `${ano}-${mes}`);
        } else if (ano) {
            // Filtrar por ano apenas (todos os meses do ano)
            params.append('ano', ano);
        } else if (mes) {
            // Filtrar por mês apenas (independente do ano) - usar like para buscar --mes
            params.append('mes_like', `--${mes}`);
        }

        if (imovelId) params.append('imovel_id', imovelId);
        if (status !== '') params.append('pago', status);

        const queryString = params.toString();
        const url = queryString ? `/api/alugueis/grid-data?${queryString}` : '/api/alugueis/grid-data';
        console.log('Carregando dados do grid a partir de:', url);

        const gridData = await fetchWithAuth(url);

        if (!gridData) {
            throw new Error('Resposta vazia ao carregar dados de aluguéis');
        }

        alugueisGridRows = gridData.rows || [];
        proprietariosGrid = gridData.proprietarios || [];

        const colHeaders = (gridData.col_headers && gridData.col_headers.length)
            ? gridData.col_headers
            : [gridData.mes_label || 'Imóvel', 'Valor Total', ...proprietariosGrid.map((p) => p.nome)];

        if (!alugueisGridRows.length) {
            container.innerHTML = '';
            if (emptyState) emptyState.classList.remove('hidden');
            return;
        }

        const tableData = alugueisGridRows.map((row) => {
            const formatted = [
                row.imovel_nome,
                formatCurrencyPlain(row.valor_total)
            ];

            proprietariosGrid.forEach((prop) => {
                const valor = row.distribuicao && typeof row.distribuicao[prop.id] !== 'undefined'
                    ? row.distribuicao[prop.id]
                    : 0;
                formatted.push(formatCurrencyPlain(valor));
            });

            return formatted;
        });

        const columns = [
            { data: 0, readOnly: true },
            { data: 1, readOnly: true }
        ];

        for (let i = 0; i < proprietariosGrid.length; i += 1) {
            columns.push({ data: i + 2, readOnly: true });
        }

        const calculatedHeight = Math.min(600, 140 + (tableData.length * 38));

        alugueisHot = new Handsontable(container, {
            data: tableData,
            colHeaders,
            columns,
            rowHeaders: false,
            stretchH: 'none',
            height: calculatedHeight,
            licenseKey: 'non-commercial-and-evaluation',
            readOnly: true,
            autoColumnSize: {
                samplingRatio: 23,
                useHeaders: true
            },
            manualColumnResize: true,
            manualRowResize: false,
            fillHandle: false,
            contextMenu: false,
            multiColumnSorting: false,
            selectionMode: 'single',
            className: 'htMiddle',
            afterSelectionEnd: (row) => {
                if (typeof row === 'number' && row >= 0) {
                    selectedAluguelIndex = row;
                }
            },
            afterDeselect: () => {
                selectedAluguelIndex = null;
            },
            afterOnCellMouseDown: (event, coords) => {
                if (coords.row >= 0) {
                    selectedAluguelIndex = coords.row;
                    if (event && event.detail === 2) {
                        const selecionado = getSelectedAluguel();
                        if (selecionado) {
                            editarAluguel(selecionado.aluguel_id);
                        }
                    }
                }
            },
            beforeKeyDown: (event) => {
                if (!event) return;
                const selecionado = getSelectedAluguel();

                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (selecionado) {
                        editarAluguel(selecionado.aluguel_id);
                    }
                }

                if ((event.key === 'Delete' || event.key === 'Backspace') && selecionado) {
                    event.preventDefault();
                    deletarAluguel(selecionado.aluguel_id);
                }
            },
            cells: function (row, col) {
                const cellProperties = { readOnly: true };

                if (col === 0) {
                    cellProperties.className = 'htLeft htMiddle font-semibold text-white';
                } else {
                    cellProperties.className = 'htRight htMiddle';
                    const value = this.instance.getDataAtCell(row, col);
                    if (typeof value === 'string' && value.trim().startsWith('-')) {
                        cellProperties.className += ' negative-value';
                    }
                }

                return cellProperties;
            }
        });
    } catch (error) {
        console.error('Erro ao carregar aluguéis:', error);
        showToast('Erro ao carregar aluguéis', 'error');
        if (emptyState) emptyState.classList.remove('hidden');
    } finally {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
}

// Editar aluguel
async function editarAluguel(id) {
    try {
        const aluguel = await fetchWithAuth(`/api/alugueis/${id}`);
        if (aluguel) {
            
            document.getElementById('modal-title').textContent = 'Editar Aluguel';
            document.getElementById('aluguel-id').value = aluguel.id;
            document.getElementById('aluguel-imovel').value = aluguel.imovel_id;
            document.getElementById('aluguel-mes').value = aluguel.mes_referencia;
            document.getElementById('aluguel-valor-total').value = aluguel.valor_total;
            document.getElementById('aluguel-pago').checked = aluguel.pago;
            
            const modal = document.getElementById('modal-aluguel');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    } catch (error) {
        console.error('Erro ao carregar aluguel:', error);
        showToast('Erro ao carregar aluguel', 'error');
    }
}

// Deletar aluguel
async function deletarAluguel(id) {
    if (!confirm('Tem certeza que deseja excluir este aluguel?')) return;
    
    try {
        // fetchWithAuth retorna true para DELETE bem-sucedido
        await fetchWithAuth(`/api/alugueis/${id}`, {
            method: 'DELETE'
        });
        
        showToast('Aluguel excluído com sucesso!', 'success');
        loadAlugueis();
        loadStats();
    } catch (error) {
        console.error('Erro ao excluir aluguel:', error);
        showToast(error.message || 'Erro ao excluir aluguel', 'error');
    }
}

// Salvar aluguel
async function salvarAluguel(event) {
    event.preventDefault();
    
    const id = document.getElementById('aluguel-id').value;
    const isEdit = id !== '';
    
    const data = {
        imovel_id: parseInt(document.getElementById('aluguel-imovel').value),
        mes_referencia: document.getElementById('aluguel-mes').value,
        valor_total: parseFloat(document.getElementById('aluguel-valor-total').value) || 0,
        pago: document.getElementById('aluguel-pago').checked
    };
    
    try {
        const url = isEdit ? `/api/alugueis/${id}` : '/api/alugueis/';
        const method = isEdit ? 'PUT' : 'POST';
        
        // fetchWithAuth retorna o JSON diretamente
        const result = await fetchWithAuth(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        showToast(`Aluguel ${isEdit ? 'atualizado' : 'criado'} com sucesso!`, 'success');
        fecharModal();
        loadAlugueis();
        loadStats();
    } catch (error) {
        console.error('Erro ao salvar aluguel:', error);
        showToast(error.message || 'Erro ao salvar aluguel', 'error');
    }
}

// Fechar modal
function fecharModal() {
    const modal = document.getElementById('modal-aluguel');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== DOMContentLoaded disparado ===');
    loadImoveis();
    loadAnos();
    loadStats();
    loadAlugueis();
    
    // Logout - verificar se elemento existe
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => logout());
    }
    
    // Filtros automáticos
    const filterAno = document.getElementById('filter-ano');
    const filterMes = document.getElementById('filter-mes');
    const filterImovel = document.getElementById('filter-imovel');
    const filterStatus = document.getElementById('filter-status');
    
    if (filterAno) {
        filterAno.addEventListener('change', () => {
            loadAlugueis();
            loadStats();
        });
    }
    
    if (filterMes) {
        filterMes.addEventListener('change', () => {
            loadAlugueis();
            loadStats();
        });
    }
    
    if (filterImovel) {
        filterImovel.addEventListener('change', () => {
            loadAlugueis();
            loadStats();
        });
    }
    
    if (filterStatus) {
        filterStatus.addEventListener('change', () => {
            loadAlugueis();
            loadStats();
        });
    }
    
    // Modal
    const btnFecharModal = document.getElementById('btn-fechar-modal');
    const btnCancelarModal = document.getElementById('btn-cancelar-modal');
    const formAluguel = document.getElementById('form-aluguel');
    
    if (btnFecharModal) {
        btnFecharModal.addEventListener('click', fecharModal);
    }
    if (btnCancelarModal) {
        btnCancelarModal.addEventListener('click', fecharModal);
    }
    if (formAluguel) {
        formAluguel.addEventListener('submit', salvarAluguel);
    }
    
    // Atualizar preview do total
    const valorTotalInput = document.getElementById('aluguel-valor-total');
    if (valorTotalInput) {
        valorTotalInput.addEventListener('input', () => {
            const valor = parseFloat(valorTotalInput.value) || 0;
            document.getElementById('aluguel-total-preview').textContent = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        });
    }
});
</script>
{% endblock %}
