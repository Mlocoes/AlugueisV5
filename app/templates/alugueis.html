{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css" />
<style>
    .htDarkTable .handsontable td,
    .htDarkTable .handsontable th {
        background-color: var(--card-dark);
        color: #f9fafb;
        border-color: #334155;
    }

    .htDarkTable .handsontable thead th {
        background-color: var(--bg-dark);
        font-weight: 600;
    }

    .htDarkTable .handsontable .negative-value {
        color: #f87171 !important;
    }

    #alugueis-handsontable {
        min-height: 440px;
        width: 100%;
    }

    .handsontable .htRight {
        text-align: right;
    }

    .handsontable .htLeft {
        text-align: left;
    }

    .htDarkTable .wtHolder {
        border: 1px solid #334155;
        border-radius: 8px;
        overflow: hidden;
    }

    .htDarkTable .handsontable tbody tr:hover td {
        background-color: rgba(148, 163, 184, 0.08);
    }

    .htDarkTable .handsontable .htBorder.current {
        border-color: var(--primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-bg-dark">
    <!-- Navbar -->
    {% include "navbar.html" %}

    <!-- Main Content -->
    <div class="container mx-auto px-4 pb-8">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Aluguéis Mensais</h2>
        </div>

        <!-- Filtros -->
        <div class="bg-card-dark rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Mês</label>
                    <input type="month" id="filter-mes" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Imóvel</label>
                    <select id="filter-imovel" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-3 py-2">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Status</label>
                    <select id="filter-status" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-3 py-2">
                        <option value="">Todos</option>
                        <option value="true">Pago</option>
                        <option value="false">Pendente</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button id="btn-filtrar" class="flex-1 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Filtrar
                    </button>
                    <button id="btn-limpar-filtros" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        Limpar
                    </button>
                </div>
            </div>
        </div>

        <!-- Grid Handsontable -->
        <div class="bg-card-dark rounded-lg p-4 htDarkTable">
            <div class="flex flex-col gap-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <p class="text-sm text-gray-400">Dê um duplo clique em um imóvel para editar.</p>
                    <div class="flex gap-2">
                    </div>
                </div>
                <div class="relative">
                    <div id="alugueis-loading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-bg-dark/70 backdrop-blur-sm" style="display: none;">
                        <div class="animate-spin rounded-full h-10 w-10 border-2 border-primary border-t-transparent"></div>
                        <p class="mt-4 text-gray-300 text-sm">Carregando aluguéis...</p>
                    </div>
                    <div id="alugueis-empty" class="hidden py-12 text-center text-gray-400 text-sm">
                        <span class="material-symbols-outlined text-5xl block mb-3">inbox</span>
                        Nenhum aluguel encontrado para os filtros selecionados.
                    </div>
                    <div id="alugueis-handsontable"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Novo/Editar Aluguel -->
<div id="modal-aluguel" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4">
    <div class="bg-card-dark rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Novo Aluguel</h3>
                <button id="btn-fechar-modal" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="form-aluguel">
                <input type="hidden" id="aluguel-id">

                <!-- Imóvel e Mês -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Imóvel *</label>
                        <select id="aluguel-imovel" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="">Selecione o imóvel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Mês de Referência *</label>
                        <input type="month" id="aluguel-mes" required class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>

                <!-- Valores Principais -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Valores</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluguel</label>
                            <input type="number" step="0.01" id="aluguel-valor-aluguel" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Condomínio</label>
                            <input type="number" step="0.01" id="aluguel-valor-condominio" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">IPTU</label>
                            <input type="number" step="0.01" id="aluguel-valor-iptu" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Luz</label>
                            <input type="number" step="0.01" id="aluguel-valor-luz" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Água</label>
                            <input type="number" step="0.01" id="aluguel-valor-agua" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Gás</label>
                            <input type="number" step="0.01" id="aluguel-valor-gas" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Internet</label>
                            <input type="number" step="0.01" id="aluguel-valor-internet" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Outros</label>
                            <input type="number" step="0.01" id="aluguel-valor-outros" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex items-end">
                            <div class="w-full bg-primary/20 border border-primary rounded-lg px-4 py-2">
                                <div class="text-xs text-gray-400">Total</div>
                                <div class="text-lg font-bold text-white" id="aluguel-total-preview">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status de Pagamento -->
                <div class="mb-4">
                    <h4 class="text-white font-semibold mb-3">Status de Pagamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="aluguel-pago" class="w-5 h-5 text-primary bg-bg-dark border-border-dark rounded focus:ring-primary">
                            <label for="aluguel-pago" class="ml-2 text-gray-300">Marcar como pago</label>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data de Pagamento</label>
                            <input type="date" id="aluguel-data-pagamento" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Observações</label>
                    <textarea id="aluguel-observacoes" rows="3" class="w-full bg-bg-dark border border-border-dark text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Observações sobre este aluguel..."></textarea>
                </div>

                <!-- Botões -->
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors">
                        Salvar Aluguel
                    </button>
                    <button type="button" id="btn-cancelar-modal" class="px-6 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
<script>
console.log('=== ALUGUEIS.HTML: Script carregado ===');

let alugueisHot = null;
let alugueisGridRows = [];
let proprietariosGrid = [];
let selectedAluguelIndex = null;
let imoveisData = [];

function formatCurrencyPlain(value) {
    const numericValue = typeof value === 'number' ? value : parseFloat(value) || 0;
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericValue);
}

function getSelectedAluguel() {
    if (selectedAluguelIndex === null) return null;
    return alugueisGridRows[selectedAluguelIndex] || null;
}

// Carregar informações do usuário
// Carregar imóveis para os selects
async function loadImoveis() {
    console.log('loadImoveis: iniciando');
    try {
        imoveisData = await fetchWithAuth('/api/imoveis/?is_active=true&limit=1000');
        if (imoveisData) {
            
            const selectFiltro = document.getElementById('filter-imovel');
            const selectModal = document.getElementById('aluguel-imovel');
            
            if (selectFiltro) {
                selectFiltro.innerHTML = '<option value="">Todos os imóveis</option>';
                imoveisData.forEach(imovel => {
                    const option = document.createElement('option');
                    option.value = imovel.id;
                    option.textContent = `${imovel.nome} - ${imovel.endereco}`;
                    selectFiltro.appendChild(option);
                });
            }
            
            if (selectModal) {
                selectModal.innerHTML = '<option value="">Selecione o imóvel</option>';
                imoveisData.forEach(imovel => {
                    const option = document.createElement('option');
                    option.value = imovel.id;
                    option.textContent = `${imovel.nome} - ${imovel.endereco}`;
                    selectModal.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar imóveis:', error);
    }
}

// Carregar estatísticas
async function loadStats() {
    try {
        const stats = await fetchWithAuth('/api/alugueis/stats/summary');
        if (!stats) return;

        const statElements = {
            'stat-total': stats.total_alugueis,
            'stat-pagos': stats.pagos,
            'stat-pendentes': stats.pendentes,
            'stat-recebido': formatCurrency(stats.valor_total_recebido),
            'stat-pendente': formatCurrency(stats.valor_total_pendente)
        };

        for (const [id, value] of Object.entries(statElements)) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Carregar aluguéis
async function loadAlugueis() {
    console.log('loadAlugueis: iniciando');
    const container = document.getElementById('alugueis-handsontable');
    const loadingOverlay = document.getElementById('alugueis-loading');
    const emptyState = document.getElementById('alugueis-empty');

    if (!container) {
        console.warn('Container Handsontable não encontrado');
        return;
    }

    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
    if (emptyState) emptyState.classList.add('hidden');

    selectedAluguelIndex = null;
    alugueisGridRows = [];
    proprietariosGrid = [];

    if (alugueisHot) {
        alugueisHot.destroy();
        alugueisHot = null;
    }
    container.innerHTML = '';

    try {
        const params = new URLSearchParams();

        const mes = document.getElementById('filter-mes')?.value;
        const imovelId = document.getElementById('filter-imovel')?.value;
        const status = document.getElementById('filter-status')?.value;

        if (mes) params.append('mes_referencia', mes);
        if (imovelId) params.append('imovel_id', imovelId);
        if (status !== '') params.append('pago', status);

        const queryString = params.toString();
        const url = queryString ? `/api/alugueis/grid-data?${queryString}` : '/api/alugueis/grid-data';
        console.log('Carregando dados do grid a partir de:', url);

        const gridData = await fetchWithAuth(url);

        if (!gridData) {
            throw new Error('Resposta vazia ao carregar dados de aluguéis');
        }

        alugueisGridRows = gridData.rows || [];
        proprietariosGrid = gridData.proprietarios || [];

        const colHeaders = (gridData.col_headers && gridData.col_headers.length)
            ? gridData.col_headers
            : [gridData.mes_label || 'Imóvel', 'Valor Total', ...proprietariosGrid.map((p) => p.nome)];

        if (!alugueisGridRows.length) {
            container.innerHTML = '';
            if (emptyState) emptyState.classList.remove('hidden');
            return;
        }

        const tableData = alugueisGridRows.map((row) => {
            const formatted = [
                row.imovel_nome,
                formatCurrencyPlain(row.valor_total)
            ];

            proprietariosGrid.forEach((prop) => {
                const valor = row.distribuicao && typeof row.distribuicao[prop.id] !== 'undefined'
                    ? row.distribuicao[prop.id]
                    : 0;
                formatted.push(formatCurrencyPlain(valor));
            });

            return formatted;
        });

        const columns = [
            { data: 0, readOnly: true },
            { data: 1, readOnly: true }
        ];

        for (let i = 0; i < proprietariosGrid.length; i += 1) {
            columns.push({ data: i + 2, readOnly: true });
        }

        const calculatedHeight = Math.min(600, 140 + (tableData.length * 38));

        alugueisHot = new Handsontable(container, {
            data: tableData,
            colHeaders,
            columns,
            rowHeaders: false,
            stretchH: 'none',
            height: calculatedHeight,
            licenseKey: 'non-commercial-and-evaluation',
            readOnly: true,
            autoColumnSize: {
                samplingRatio: 23,
                useHeaders: true
            },
            manualColumnResize: true,
            manualRowResize: false,
            fillHandle: false,
            contextMenu: false,
            multiColumnSorting: false,
            selectionMode: 'single',
            className: 'htMiddle',
            afterSelectionEnd: (row) => {
                if (typeof row === 'number' && row >= 0) {
                    selectedAluguelIndex = row;
                }
            },
            afterDeselect: () => {
                selectedAluguelIndex = null;
            },
            afterOnCellMouseDown: (event, coords) => {
                if (coords.row >= 0) {
                    selectedAluguelIndex = coords.row;
                    if (event && event.detail === 2) {
                        const selecionado = getSelectedAluguel();
                        if (selecionado) {
                            editarAluguel(selecionado.aluguel_id);
                        }
                    }
                }
            },
            beforeKeyDown: (event) => {
                if (!event) return;
                const selecionado = getSelectedAluguel();

                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (selecionado) {
                        editarAluguel(selecionado.aluguel_id);
                    }
                }

                if ((event.key === 'Delete' || event.key === 'Backspace') && selecionado) {
                    event.preventDefault();
                    deletarAluguel(selecionado.aluguel_id);
                }
            },
            cells: function (row, col) {
                const cellProperties = { readOnly: true };

                if (col === 0) {
                    cellProperties.className = 'htLeft htMiddle font-semibold text-white';
                } else {
                    cellProperties.className = 'htRight htMiddle';
                    const value = this.instance.getDataAtCell(row, col);
                    if (typeof value === 'string' && value.trim().startsWith('-')) {
                        cellProperties.className += ' negative-value';
                    }
                }

                return cellProperties;
            }
        });
    } catch (error) {
        console.error('Erro ao carregar aluguéis:', error);
        showToast('Erro ao carregar aluguéis', 'error');
        if (emptyState) emptyState.classList.remove('hidden');
    } finally {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
}

// Editar aluguel
async function editarAluguel(id) {
    try {
        const aluguel = await fetchWithAuth(`/api/alugueis/${id}`);
        if (aluguel) {
            
            document.getElementById('modal-title').textContent = 'Editar Aluguel';
            document.getElementById('aluguel-id').value = aluguel.id;
            document.getElementById('aluguel-imovel').value = aluguel.imovel_id;
            document.getElementById('aluguel-mes').value = aluguel.mes_referencia;
            document.getElementById('aluguel-valor-aluguel').value = aluguel.valor_aluguel;
            document.getElementById('aluguel-valor-condominio').value = aluguel.valor_condominio;
            document.getElementById('aluguel-valor-iptu').value = aluguel.valor_iptu;
            document.getElementById('aluguel-valor-luz').value = aluguel.valor_luz;
            document.getElementById('aluguel-valor-agua').value = aluguel.valor_agua;
            document.getElementById('aluguel-valor-gas').value = aluguel.valor_gas;
            document.getElementById('aluguel-valor-internet').value = aluguel.valor_internet;
            document.getElementById('aluguel-valor-outros').value = aluguel.outros_valores;
            document.getElementById('aluguel-pago').checked = aluguel.pago;
            document.getElementById('aluguel-data-pagamento').value = aluguel.data_pagamento || '';
            document.getElementById('aluguel-observacoes').value = aluguel.observacoes || '';
            
            atualizarTotalPreview();
            const modal = document.getElementById('modal-aluguel');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    } catch (error) {
        console.error('Erro ao carregar aluguel:', error);
        showToast('Erro ao carregar aluguel', 'error');
    }
}

// Deletar aluguel
async function deletarAluguel(id) {
    if (!confirm('Tem certeza que deseja excluir este aluguel?')) return;
    
    try {
        // fetchWithAuth retorna true para DELETE bem-sucedido
        await fetchWithAuth(`/api/alugueis/${id}`, {
            method: 'DELETE'
        });
        
        showToast('Aluguel excluído com sucesso!', 'success');
        loadAlugueis();
        loadStats();
    } catch (error) {
        console.error('Erro ao excluir aluguel:', error);
        showToast(error.message || 'Erro ao excluir aluguel', 'error');
    }
}

// Atualizar preview do total
function atualizarTotalPreview() {
    const valores = [
        'aluguel-valor-aluguel', 'aluguel-valor-condominio', 'aluguel-valor-iptu',
        'aluguel-valor-luz', 'aluguel-valor-agua', 'aluguel-valor-gas',
        'aluguel-valor-internet', 'aluguel-valor-outros'
    ];
    
    let total = 0;
    valores.forEach(id => {
        const valor = parseFloat(document.getElementById(id).value) || 0;
        total += valor;
    });
    
    document.getElementById('aluguel-total-preview').textContent = formatCurrency(total);
}

// Salvar aluguel
async function salvarAluguel(event) {
    event.preventDefault();
    
    const id = document.getElementById('aluguel-id').value;
    const isEdit = id !== '';
    
    const data = {
        imovel_id: parseInt(document.getElementById('aluguel-imovel').value),
        mes_referencia: document.getElementById('aluguel-mes').value,
        valor_aluguel: parseFloat(document.getElementById('aluguel-valor-aluguel').value) || 0,
        valor_condominio: parseFloat(document.getElementById('aluguel-valor-condominio').value) || 0,
        valor_iptu: parseFloat(document.getElementById('aluguel-valor-iptu').value) || 0,
        valor_luz: parseFloat(document.getElementById('aluguel-valor-luz').value) || 0,
        valor_agua: parseFloat(document.getElementById('aluguel-valor-agua').value) || 0,
        valor_gas: parseFloat(document.getElementById('aluguel-valor-gas').value) || 0,
        valor_internet: parseFloat(document.getElementById('aluguel-valor-internet').value) || 0,
        outros_valores: parseFloat(document.getElementById('aluguel-valor-outros').value) || 0,
        pago: document.getElementById('aluguel-pago').checked,
        data_pagamento: document.getElementById('aluguel-data-pagamento').value || null,
        observacoes: document.getElementById('aluguel-observacoes').value || null
    };
    
    try {
        const url = isEdit ? `/api/alugueis/${id}` : '/api/alugueis/';
        const method = isEdit ? 'PUT' : 'POST';
        
        // fetchWithAuth retorna o JSON diretamente
        const result = await fetchWithAuth(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        showToast(`Aluguel ${isEdit ? 'atualizado' : 'criado'} com sucesso!`, 'success');
        fecharModal();
        loadAlugueis();
        loadStats();
    } catch (error) {
        console.error('Erro ao salvar aluguel:', error);
        showToast(error.message || 'Erro ao salvar aluguel', 'error');
    }
}

// Fechar modal
function fecharModal() {
    const modal = document.getElementById('modal-aluguel');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== DOMContentLoaded disparado ===');
    loadImoveis();
    loadStats();
    loadAlugueis();
    
    // Logout - verificar se elemento existe
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => logout());
    }
    
    // Botões
    const btnFiltrar = document.getElementById('btn-filtrar');
    const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
    
    if (btnFiltrar) {
        btnFiltrar.addEventListener('click', () => {
            loadAlugueis();
            loadStats();
        });
    }
    
    if (btnLimparFiltros) {
        btnLimparFiltros.addEventListener('click', () => {
            const filterMes = document.getElementById('filter-mes');
            const filterImovel = document.getElementById('filter-imovel');
            const filterStatus = document.getElementById('filter-status');
            
            if (filterMes) filterMes.value = '';
            if (filterImovel) filterImovel.value = '';
            if (filterStatus) filterStatus.value = '';
            
            loadAlugueis();
            loadStats();
        });
    }
    
    // Modal
    const btnFecharModal = document.getElementById('btn-fechar-modal');
    const btnCancelarModal = document.getElementById('btn-cancelar-modal');
    const formAluguel = document.getElementById('form-aluguel');
    
    if (btnFecharModal) {
        btnFecharModal.addEventListener('click', fecharModal);
    }
    if (btnCancelarModal) {
        btnCancelarModal.addEventListener('click', fecharModal);
    }
    if (formAluguel) {
        formAluguel.addEventListener('submit', salvarAluguel);
    }
    
    // Atualizar preview ao digitar valores
    const valorInputs = [
        'aluguel-valor-aluguel', 'aluguel-valor-condominio', 'aluguel-valor-iptu',
        'aluguel-valor-luz', 'aluguel-valor-agua', 'aluguel-valor-gas',
        'aluguel-valor-internet', 'aluguel-valor-outros'
    ];
    
    valorInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', atualizarTotalPreview);
        }
    });
    
    // Fechar modal ao clicar fora
    const modalAluguel = document.getElementById('modal-aluguel');
    if (modalAluguel) {
        modalAluguel.addEventListener('click', (e) => {
            if (e.target.id === 'modal-aluguel') {
                fecharModal();
            }
        });
    }
});
</script>
{% endblock %}
